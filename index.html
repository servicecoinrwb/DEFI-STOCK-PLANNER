<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeFi to Dividends Planner</title>
    <!-- Fix for favicon 404 error -->
    <link rel="icon" href="data:,">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --text-muted: #707070;
            --accent-primary: #007bff;
            --accent-primary-hover: #0056b3;
            --accent-positive: #28a745;
            --accent-negative: #dc3545;
            --border-color: #3a3a3a;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0,0,0,0.15);
        }

        /* General Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 24px;
            font-size: 14px;
        }
        * { box-sizing: border-box; }
        h1, h2, h3, h4 { 
            margin: 0 0 8px 0;
            font-weight: 600;
            color: var(--text-primary);
        }
        h1 { font-size: 28px; }
        h2 { font-size: 20px; }
        h3 { font-size: 18px; }
        h4 { font-size: 16px; color: var(--text-secondary); margin-top: 16px;}

        /* Layouts */
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }
        .grid {
            display: grid;
            gap: 16px;
        }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        .row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .hr {
            border: 0;
            height: 1px;
            background-color: var(--border-color);
            margin: 16px 0;
        }

        /* Components */
        .input, select {
            width: 100%;
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input:focus, select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }
        .btn, a.btn {
            background-color: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn:hover, a.btn:hover { background-color: var(--accent-primary-hover); }
        .btn:active, a.btn:active { transform: scale(0.98); }
        .btn.ghost, a.btn.ghost {
            background-color: transparent;
            color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
        }
        .btn.ghost:hover, a.btn.ghost:hover { background-color: rgba(0, 123, 255, 0.1); }
        .btn:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
        }
        
        .badge {
            background-color: var(--bg-tertiary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
        }
        .note { color: var(--text-secondary); font-size: 13px; max-width: 80ch; }
        .small { font-size: 12px; }
        .muted { color: var(--text-muted); }
        .mono { font-family: 'JetBrains Mono', monospace; }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: var(--bg-tertiary);
            padding: 8px 12px;
            border-radius: 99px;
            cursor: pointer;
            user-select: none;
        }
        .pill input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
        }
        
        .up { color: var(--accent-positive); }
        .down { color: var(--accent-negative); }
        .warning { color: #ffc107; }

        /* Table Styles */
        .table-container {
            width: 100%;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
        }
        tbody tr:last-child td { border-bottom: none; }
        .right { text-align: right; }
        td input {
            padding: 6px 8px;
            font-size: 13px;
            min-width: 80px;
        }
        .btn-delete {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }
        .btn-delete:hover { color: var(--accent-negative); }

        /* Accordion */
        .accordion {
            display: none;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        .accordion ul, .accordion ol { margin: 8px 0 8px 20px; padding: 0;}
        .accordion li { margin-bottom: 5px; }
        .accordion table { max-width: 500px; margin: 10px 0; }
        .accordion th, .accordion td { font-size: 13px; padding: 6px 8px; }

        .kbd {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 220px;
        }
        
        /* Sync Status & Auth UI */
        #auth-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-tertiary);
            padding: 4px 12px 4px 4px;
            border-radius: 99px;
            border: 1px solid var(--border-color);
        }
        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-primary);
        }
        .user-name {
            font-size: 13px;
            font-weight: 500;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #syncStatus {
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        #syncStatus.saving { color: var(--accent-primary); }
        #syncStatus.saved { color: var(--accent-positive); }
        #syncStatus.error { color: var(--accent-negative); }
    </style>
</head>
<body>

    <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap: wrap;">
        <h1 style="margin-bottom:0;">DeFi to Dividends Planner</h1>
        
        <!-- Auth Header -->
        <div id="auth-container">
            <div id="syncStatus" title="Sync Status"></div>
            <div id="user-display" class="user-profile" style="display:none;">
                <img id="user-img" class="user-avatar" src="" alt="Profile">
                <span id="user-name" class="user-name">User</span>
            </div>
            <button id="btn-login" class="btn">Sign In</button>
            <button id="btn-logout" class="btn ghost" style="display:none;">Sign Out</button>
        </div>
    </div>
    
    <div class="row" style="margin-bottom: 16px;">
        <a href="https://debank.com/profile/0x4386a86277a03ff37188416767ad74e4381b226c" target="_blank" class="btn ghost">View DeBank Profile ‚Üó</a>
    </div>

    <!-- Combined DeFi + Stock Yield Summary -->
    <section class="card" id="summaryCard">
      <h2 class="title">Combined Income Summary</h2>
      <div class="row" style="gap:12px; flex-wrap:wrap">
        <div class="badge">On‚Äëchain daily (USD): <b id="sumDaily" style="margin-left:6px">$0.00</b></div>
        <div class="badge">Kept on‚Äëchain / year: <b id="sumDefiYear" style="margin-left:6px">$0</b></div>
        <div class="badge">Net to stocks / year: <b id="sumToStocksYear" style="margin-left:6px">$0</b></div>
        <div class="badge">Est. dividends in year 1: <b id="sumDivYear" style="margin-left:6px">$0</b></div>
        <div class="badge">Combined yearly cashflow: <b id="sumCombinedYear" style="margin-left:6px">$0</b></div>
        <div class="badge">Blended income rate: <b id="sumBlendedYield" style="margin-left:6px">‚Äì</b></div>
      </div>
      <div class="row" style="gap:10px; margin-top:10px; align-items:flex-end; flex-wrap:wrap">
        <div style="width:180px">
          <label class="small muted">Brokerage balance (USD)</label>
          <input class="input" id="broBalance" type="number" step="0.01" value="1230.00"/>
        </div>
        <div style="width:150px">
          <label class="small muted">Interest Rate (%)</label>
          <input class="input" id="broInterestRate" type="number" step="0.01" value="3.75"/>
        </div>
        <label class="pill"><input type="checkbox" id="broInterestInclude"/> Include Interest in Rewards</label>
        <label class="pill"><input type="checkbox" id="broInclude" checked/> Include in Blended Rate</label>
      </div>
      <div class="note" style="margin-top:6px">Dividends assume average yield and current contribution rate. If DRIP is on, dividends are reinvested (shown here for comparison).</div>
    </section>

    <!-- ETF Wizard -->
    <section class="card" id="etfCard" style="margin-top:16px">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h2 class="title">ETF Wizard ü™Ñ (for fun)</h2>
          <div class="note">Give your plan a pretend ETF ticker & name. We compute a live NAV from your <b>Stake USD + annual stock contributions</b>. Purely illustrative.</div>
        </div>
        <div class="row" style="gap:8px;align-items:center">
          <button class="btn ghost" id="btnEtfHelp">‚ùì Tutorial</button>
          <div class="badge">Change: <b id="etfChange" class="mono">0.00%</b></div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="grid grid-3">
        <div>
          <label class="small muted">ETF Ticker</label>
          <input class="input" id="etfTicker" value="UDGE" maxlength="5" />
        </div>
        <div>
          <label class="small muted">ETF Name</label>
          <input class="input" id="etfName" value="Utility Dividend Growth ETF" />
        </div>
        <div>
          <label class="small muted">Start NAV (USD)</label>
          <input class="input" id="etfStartNav" type="number" step="0.01" value="10" />
        </div>
      </div>
      <div class="grid grid-3" style="margin-top:10px">
        <div>
          <label class="small muted">Shares Outstanding</label>
          <input class="input" id="etfShares" type="number" step="1" value="1000000" />
        </div>
        <div>
          <label class="small muted">Live NAV (USD)</label>
          <div class="badge mono" id="etfNav">$0.00</div>
        </div>
        <div>
          <label class="small muted">AUM (USD)</label>
          <div class="badge mono" id="etfAUM">$0</div>
        </div>
      </div>
       <div class="hr"></div>
        <h3 class="title" style="font-size: 16px;">Fund Manager Simulator</h3>
        <div class="row" style="align-items:flex-end">
            <div style="width: 200px;">
                <label class="small muted">Number of Shares</label>
                <input class="input" id="simShares" type="number" value="10000" step="1">
            </div>
            <button class="btn" id="btnSimBuy">Buy Shares (Redeem)</button>
            <button class="btn" id="btnSimSell">Sell Shares (Create)</button>
            <button class="btn ghost" id="btnSetNavTo10" style="margin-left: auto;">Set NAV to $10</button>
        </div>
      <div id="etfHelp" class="accordion">
        <div class="hr"></div>
        <h3 class="title" style="font-size:18px">ETF Wizard ‚Äî Quick Tutorial</h3>
        <p class="note">Simulate your own ETF built from your plan. This is just for fun, not a real security.</p>
        <ol style="margin:0 0 10px 18px; padding:0; color: var(--text-secondary); line-height: 1.6;">
          <li><b>Name it:</b> Pick a fun <span class="kbd">Ticker</span> and <span class="kbd">Name</span>.</li>
          <li><b>Choose a baseline:</b> Set <span class="kbd">Start NAV</span> (e.g., $10.00) and <span class="kbd">Shares Outstanding</span>.</li>
          <li><b>We compute NAV:</b> <i>Live NAV</i> = (<b>Stake USD</b> + <b>Annual stock contributions</b>) √∑ <b>Shares</b>.</li>
          <li><b>% Change:</b> vs your Start NAV; turns <span class="up">green</span> when rising and <span class="down">red</span> when falling.</li>
        </ol>
        <div class="grid grid-3">
          <div>
            <div class="small muted">Tip</div>
            <div class="badge">Include brokerage in blended rate at the top to change your context yield.</div>
          </div>
          <div>
            <div class="small muted">Try this</div>
            <div class="badge">Toggle xGRAIL APY vs. Epoch in the real‚Äëyield panel and watch NAV shift.</div>
          </div>
          <div>
            <div class="small muted">Glossary</div>
            <div class="badge">NAV = Net Asset Value, AUM = Assets Under Management.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- DeFi Yield Panels -->
    <div class="grid grid-2" style="margin-top:16px;">
        <!-- xGRAIL Real Yield panel -->
        <section class="card">
          <div class="row" style="justify-content:space-between;align-items:flex-start;">
            <h2 class="title">xGRAIL Real Yield ‚Üí Daily Rewards</h2>
            <a href="https://app.camelot.exchange/xgrail/staking" target="_blank" class="btn ghost">Go to Staking ‚Üó</a>
          </div>
          <div class="note">Use this to auto‚Äëcalculate your <b>Daily DeFi rewards (USD)</b> from xGRAIL.</div>
          <div class="hr"></div>
          <div class="row" style="gap:10px; align-items:flex-end; flex-wrap:wrap">
            <label class="pill"><input type="checkbox" id="xgUse" checked/> Use xGRAIL to set Daily</label>
            <div style="width:140px">
              <label class="small muted">xGRAIL allocated</label>
              <input class="input" id="xgAmount" type="number" step="0.001" value="130.005"/>
            </div>
            <div style="flex-grow: 1; min-width: 380px;">
                <div class="row" style="align-items:flex-end; gap:8px; flex-wrap: nowrap;">
                    <div style="flex-grow: 1;">
                        <label class="small muted">CoinGecko ID (<a href="https://www.coingecko.com/" target="_blank" style="color:var(--text-secondary)">Find ID</a>)</label>
                        <div class="row" style="gap:4px; flex-wrap: nowrap;">
                            <input class="input" id="grailCoingeckoId" value="camelot-token"/>
                            <button class="btn" id="btnFetchGrailPrice" style="padding: 10px 12px;">‚ö°</button>
                        </div>
                    </div>
                    <div style="width:140px">
                        <label class="small muted">GRAIL price (USD)</label>
                        <input class="input" id="xgPrice" type="number" step="0.01" placeholder="e.g., 42.00"/>
                    </div>
                </div>
            </div>
            <div style="width:150px">
              <label class="small muted">Method</label>
              <select id="xgMethod" class="input">
                <option value="apy" selected>APY %</option>
                <option value="epoch">$ / xGRAIL / epoch</option>
              </select>
            </div>
            <div id="xgAPYWrap" style="width:140px">
              <label class="small muted">APY (%)</label>
              <input class="input" id="xgAPY" type="number" step="0.01" value="38.61"/>
            </div>
            <div id="xgUSDWrap" style="width:180px">
              <label class="small muted">Stake value (USD)</label>
              <input class="input" id="xgUsdValue" type="number" step="0.01" placeholder="e.g., 5000"/>
            </div>
            <div id="xgEpochWrap" style="display:none;gap:10px" class="row">
              <div style="width:180px">
                <label class="small muted">$ / xGRAIL / epoch</label>
                <input class="input" id="xgPerEpoch" type="number" step="0.01" value="1.53"/>
              </div>
              <div style="width:130px">
                <label class="small muted">Epoch days</label>
                <input class="input" id="xgEpochDays" type="number" step="1" value="7"/>
              </div>
            </div>
            <div style="width:120px">
              <label class="small muted">Dealloc fee %</label>
              <input class="input" id="xgFee" type="number" step="0.01" value="0.5"/>
            </div>
            <div class="badge">Computed daily from xGRAIL: <b id="xgDaily" style="margin-left:6px">$0.00</b></div>
          </div>
        </section>

        <!-- Mortgage Offset Panel -->
        <section class="card">
            <div class="row" style="justify-content:space-between;align-items:flex-start;">
                <h2 class="title">üè¶ Mortgage Offset Vault</h2>
                <a href="https://app.dolomite.io/earn" target="_blank" class="btn ghost">Go to Dolomite ‚Üó</a>
            </div>
            <div class="note">Use yield from your on-chain buffer to offset mortgage interest.</div>
            <div class="hr"></div>
             <div class="row" style="gap:10px; align-items:flex-end; flex-wrap:wrap">
                <div style="width:180px">
                    <label class="small muted">On-Chain Buffer (Dolomite)</label>
                    <input class="input" id="dolomiteBalance" type="number" step="0.01" value="3856.71"/>
                </div>
                <div style="width:140px">
                    <label class="small muted">Buffer APY (%)</label>
                    <input class="input" id="dolomiteApy" type="number" step="0.01" value="9.33"/>
                </div>
                <div style="width:180px">
                    <label class="small muted">Mortgage Rate (%)</label>
                    <input class="input" id="mortgageRate" type="number" step="0.01" value="4.125"/>
                </div>
                 <div style="width:180px">
                    <label class="small muted">Current Principal Balance</label>
                    <input class="input" id="mortgagePrincipal" type="number" step="0.01" value="38558.74"/>
                </div>
                <label class="pill"><input type="checkbox" id="dolomiteInclude"/> Include in Daily Rewards</label>
             </div>
             <div class="row" style="margin-top: 12px; gap:12px; flex-wrap:wrap">
                <div class="badge">Annual Yield: <b id="dolomiteYield" style="margin-left:6px">$0</b></div>
                <div class="badge">Monthly Yield: <b id="dolomiteMonthlyYield" style="margin-left:6px">$0</b></div>
                <div class="badge">Effective Equity vs. Loan: <b id="dolomiteEquity" style="margin-left:6px">$0</b></div>
            </div>
        </section>
    </div>

    <section class="grid grid-2" style="margin-top:16px">
      <div class="card">
        <h2 class="title">1) Inputs ‚Äî Yield & Contributions</h2>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
            <div>
                <label class="small muted">Daily DeFi rewards (USD)</label>
                <input class="input" type="number" id="daily" value="27.29" min="0" step="0.01" />
            </div>
            <div>
                <label class="small muted">Weekly Cash Contribution ($)</label>
                <input class="input" type="number" id="weeklyCash" value="1000" min="0" step="1" />
            </div>
            <div>
                <label class="small muted">Harvest cadence (DeFi)</label>
                <select id="cadence" class="input">
                    <option value="daily">Daily</option>
                    <option value="weekly" selected>Weekly</option>
                    <option value="biweekly">Bi‚ÄëWeekly</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>
        </div>
        <div class="grid grid-3" style="margin-top:10px">
          <div>
            <label class="small muted">Fees per harvest (swap+bridge+wd)</label>
            <input class="input" type="number" id="fees" value="6" min="0" step="0.01" />
          </div>
          <div>
            <label class="small muted">% routed to stocks</label>
            <input class="input" type="number" id="pctStocks" value="100" min="0" max="100" step="1" />
          </div>
          <div>
            <label class="small muted">% kept on‚Äëchain</label>
            <input class="input" type="number" id="pctDefi" value="0" min="0" max="100" step="1" />
          </div>
        </div>
        <div class="grid grid-3" style="margin-top:10px">
          <div>
            <label class="small muted">Projection years</label>
            <input class="input" type="number" id="years" value="10" min="1" max="40" step="1" />
          </div>
          <div>
            <label class="small muted">Assumed annual stock growth (%)</label>
            <input class="input" type="number" id="growth" value="6" step="0.1" />
          </div>
          <div>
            <label class="small muted">Assumed avg dividend yield (%)</label>
            <input class="input" type="number" id="yield" value="4" step="0.1" />
          </div>
        </div>
        <div class="grid grid-3" style="margin-top:10px">
            <div>
                <label class="small muted">Reinvest dividends (DRIP)</label>
                <select id="drip" class="input"><option value="yes" selected>Yes</option><option value="no">No</option></select>
            </div>
        </div>
        <div class="hr"></div>
        <div class="row">
          <div class="badge">DeFi to invest per harvest: <b id="perHarvest" style="margin-left:6px"></b></div>
          <div class="badge">Approx weekly invest: <b id="perWeek" style="margin-left:6px"></b></div>
          <div class="badge">Approx monthly invest: <b id="perMonth" style="margin-left:6px"></b></div>
        </div>
      </div>

      <div class="card">
        <h2 class="title">2) How It Works</h2>
        <ol style="margin:0 0 8px 18px; padding:0; color: var(--text-secondary); line-height: 1.6;">
          <li>Claim GRAIL rewards ‚Üí swap to USDC on Arbitrum.</li>
          <li>Bridge and withdraw to your bank (batched weekly to reduce fees).</li>
          <li>Fund your broker with DeFi rewards + weekly cash contributions.</li>
          <li>Use broker recurring buys with the allocations below.</li>
          <li>Enable DRIP so dividends auto‚Äëreinvest.</li>
          <li>Rebalance quarterly.</li>
        </ol>
        <div class="hr"></div>
        <div class="row">
          <button class="btn" id="btnCalc">‚öôÔ∏è Recalculate</button>
          <button class="btn" id="btnCSV">‚¨áÔ∏è Export Allocation CSV</button>
          <a href="https://robinhood.com/account/investing" target="_blank" class="btn ghost">Go to Broker ‚Üó</a>
        </div>
      </div>
    </section>
    
    <!-- Safety Mix Card -->
    <section class="card" style="margin-top:16px">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <h2 class="title">üß© Suggested Safety Mix (Expanded)</h2>
            <button class="btn ghost" id="btnSafetyHelp">Show Details</button>
        </div>
        <div id="safetyHelp" class="accordion">
            <div class="hr"></div>
            <h4>1. Maintain a Multi-Layered Cushion</h4>
             <p><strong>Purpose:</strong> To create a bulletproof system that provides liquidity and stability from both on-chain and traditional finance sources.</p>
             <p><strong>How it works:</strong></p>
             <ul>
                <li>Keep **$2-3k in USDC on Dolomite** earning high yield (~9.3%). This is your primary, high-earning buffer.</li>
                <li>Park another **$1-2k in a Treasury ETF like SGOV** (~5.2%) in your brokerage account. This is your risk-free, off-chain backup.</li>
             </ul>
             <p>This combo gives you a blended yield of ~7.3% on a ~$5k cushion, nearly offsetting $350-400/year of mortgage interest while providing robust liquidity.</p>

            <h4>2. Add a Short-Term Treasury ETF (5‚Äì10%) to Your Portfolio</h4>
            <p><strong>Purpose:</strong> Acts as a TradFi ‚Äúcash proxy‚Äù and yield stabilizer. When equities or DeFi are volatile, this holds steady and still pays interest (~5% annually).</p>
            <table style="max-width: 600px;">
                <thead><tr><th>ETF</th><th>Yield</th><th>Duration</th><th>Risk</th><th>Use</th></tr></thead>
                <tbody>
                    <tr><td>SGOV (iShares 0-3 Month Treasury ETF)</td><td>‚âà 5.3 %</td><td>~0.1 yr</td><td>Extremely low</td><td>Best pure safety cash park</td></tr>
                    <tr><td>BIL (SPDR 1-3 Month T-Bill ETF)</td><td>‚âà 5.2 %</td><td>~0.2 yr</td><td>Very low</td><td>Slightly more liquid than SGOV</td></tr>
                    <tr><td>SHV (Short Treasury)</td><td>‚âà 4.9 %</td><td>~0.4 yr</td><td>Low</td><td>Blend of 1‚Äì12 mo T-Bills</td></tr>
                </tbody>
            </table>
            
            <h4>3. Bridge-Fee Threshold Automation</h4>
             <p><strong>Purpose:</strong> Avoid wasting small harvests on Arbitrum ‚Üí bank bridge fees.</p>
             <p><strong>Guideline:</strong> Wait until your on-chain USDC balance ‚â• $100 before bridging to your brokerage or CEX. You can still log the amount in your planner for tracking, even if it stays on-chain that week.</p>
             <table style="max-width: 400px;">
                <thead><tr><th>Harvest</th><th>After-Fee Net</th><th>Action</th></tr></thead>
                <tbody>
                    <tr><td>$80</td><td>$74</td><td>Hold in buffer</td></tr>
                    <tr><td>$160</td><td>$154</td><td>Bridge & invest</td></tr>
                    <tr><td>$300</td><td>$292</td><td>Bridge & invest; top up SGOV/BIL position</td></tr>
                </tbody>
            </table>
            
            <h4>4. Emergency-Mode Rule (Optional)</h4>
            <p>If DeFi yield &lt; $10/day for 2+ weeks:</p>
            <ul>
                <li>Pause new stock buys.</li>
                <li>Redirect all weekly contributions into SGOV or your USDC buffer.</li>
                <li>When yield recovers above $15/day, resume normal flow.</li>
            </ul>
        </div>
    </section>

    <!-- Rebalancing Guide Card -->
    <section class="card" style="margin-top:16px">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <h2 class="title">‚öôÔ∏è Portfolio Rebalancing Guide</h2>
            <button class="btn ghost" id="btnRebalanceHelp">Show Details</button>
        </div>
         <div id="rebalanceHelp" class="accordion">
            <div class="hr"></div>
             <h4>1Ô∏è‚É£ What is Rebalancing?</h4>
             <p>Rebalancing just means realigning your portfolio back to your target allocation percentages. Over time, some holdings will go up faster while others lag, causing your weights to drift. Quarterly rebalancing brings those back in line.</p>
             
             <h4>2Ô∏è‚É£ Why Do It?</h4>
             <table>
                 <thead><tr><th>Benefit</th><th>Explanation</th></tr></thead>
                 <tbody>
                    <tr><td>‚úÖ Keeps risk consistent</td><td>Prevents one hot sector from dominating.</td></tr>
                    <tr><td>‚úÖ Enforces ‚Äúbuy low, sell high‚Äù</td><td>You trim winners and top-up laggards.</td></tr>
                    <tr><td>‚úÖ Keeps yield balanced</td><td>Prevents average income rate from drifting.</td></tr>
                    <tr><td>‚úÖ Makes compounding smoother</td><td>Keeps contributions aligned with strategy.</td></tr>
                 </tbody>
             </table>

             <h4>3Ô∏è‚É£ How to Rebalance ‚Äî Step-by-Step</h4>
             <ol>
                 <li><strong>Check Current Allocation:</strong> Once per quarter, compare your broker's % holdings to your target % in this planner.</li>
                 <li><strong>Use New Contributions First:</strong> Direct more of your next weekly buys into the under-weight tickers. This avoids selling and taxes.</li>
                 <li><strong>Optional Trim (If Needed):</strong> Only if a position grows far above target (e.g., > +3%), sell a small amount and redirect. Do this mainly in tax-advantaged accounts or if the drift is large.</li>
                 <li><strong>Update Your Planner:</strong> Update "Cum Invest $" and "Cum Shares" here to keep projections accurate.</li>
             </ol>

             <h4>4Ô∏è‚É£ How Often Is ‚ÄúQuarterly‚Äù?</h4>
             <p>4 times per year (e.g., Jan 1, Apr 1, Jul 1, Oct 1) is plenty. Consistency matters more than frequency.</p>
             
             <p><strong>‚úÖ TL;DR:</strong> Review quarterly, use new buys to adjust, trim rarely, update planner.</p>
        </div>
    </section>
    
    <!-- Tax Prep Sheet Card -->
     <section class="card" style="margin-top:16px">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <h2 class="title">üìó Tax Prep Sheet & Checklist</h2>
            <button class="btn ghost" id="btnTaxHelp">Show Details</button>
        </div>
         <div id="taxHelp" class="accordion">
            <div class="hr"></div>
             <p>This section helps organize information for tax season, aligning with your DeFi ‚Üí Dividends strategy. <strong>Note: This is not tax advice. Consult a qualified professional.</strong></p>
             
             <h4>SHEET 1 ‚Äì DeFi Income Log</h4>
             <p><strong>Purpose:</strong> Track all taxable events from your DeFi activities (claiming rewards, swapping tokens, earning interest).</p>
             <p><strong>Recommendation:</strong> Use a dedicated crypto tax software (like Koinly, CoinLedger, etc.). These tools connect to your wallets/exchanges via API or public address and automatically categorize transactions.</p>
             <p><strong>Key Data to Ensure is Captured:</strong></p>
             <ul>
                 <li>Date of each transaction (reward claim, swap, interest received).</li>
                 <li>Type of transaction (Income, Trade).</li>
                 <li>Assets involved (e.g., GRAIL ‚Üí USDC).</li>
                 <li>USD value at the time of the transaction (this determines income/cost basis).</li>
                 <li>Fees paid in crypto.</li>
             </ul>
              <p>üü¢ <strong>Tip:</strong> The total USD value of claimed rewards + interest earned (like from Dolomite) generally counts as taxable income for the year.</p>

             <h4>SHEET 2 ‚Äì Stock Dividend Summary</h4>
              <p><strong>Purpose:</strong> Understand your dividend income stream and verify against official documents.</p>
              <p><strong>Source Document:</strong> Your broker (e.g., Robinhood) will issue a **Form 1099-DIV** early each year summarizing all dividend income (Ordinary vs. Qualified).</p>
              <p><strong>Planner Use:</strong> The "Est. dividends in year 1" figure in the summary card provides a preview. Use your 1099-DIV for actual tax filing.</p>
              <p>üü¢ <strong>Tip:</strong> Reinvested dividends (DRIP) are still taxable in the year they are received. Your broker tracks the adjusted cost basis automatically.</p>
              
             <h4>SHEET 3 ‚Äì Combined Summary (Planner Data)</h4>
             <p>Use these figures from your planner as a high-level overview for your accountant:</p>
             <ul>
                 <li><strong>DeFi Income ($):</strong> Total from your crypto tax software report (Sheet 1).</li>
                 <li><strong>Stock Dividends ($):</strong> Total from your broker's 1099-DIV (Sheet 2).</li>
                 <li><strong>Total Cashflow ($):</strong> Sum of the above.</li>
             </ul>

             <h4>SHEET 4 ‚Äì Quick Tax Checklist</h4>
             <ul>
                <li>‚úÖ Crypto transaction history downloaded/synced to tax software? (Sheet 1)</li>
                <li>‚úÖ Stock 1099-DIV received from broker? (Sheet 2)</li>
                <li>‚úÖ Verified no double counting (e.g., reporting brokerage interest from 1099-INT, not manually)?</li>
                <li>‚úÖ Confirmed broker is tracking cost basis for reinvested dividends?</li>
                <li>‚úÖ Gathered records for any stock/crypto sales (if applicable)?</li>
                <li>‚úÖ Collected records for potential deductions (e.g., donations, relevant expenses)?</li>
             </ul>
        </div>
    </section>


    <!-- Deposits Logger -->
    <section class="card" style="margin-top:16px">
      <h2 class="title">2.5) Log Contributions / Deposits</h2>
      <div class="note" style="margin-bottom:8px">Record a contribution and we'll split it across your allocations, track per‚Äëticker invested dollars & shares, and update average cost. (All local to your browser.)</div>
      <div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap">
        <div style="width:160px"><label class="small muted">Amount to log ($)</label><input class="input" type="number" id="depAmount" step="0.01" placeholder="e.g., 200"/></div>
        <div style="width:180px"><label class="small muted">Use quick amount</label>
          <select class="input" id="depQuick">
            <option value="">‚Äî</option>
            <option value="week">Weekly (computed)</option>
            <option value="month">Monthly (computed)</option>
            <option value="harvest">Per‚Äëharvest (computed)</option>
          </select>
        </div>
        <div style="width:180px"><label class="small muted">Date (optional)</label><input class="input" type="date" id="depDate"/></div>
        <button class="btn" id="btnLogDeposit">‚ûï Log deposit</button>
        <button class="btn ghost" id="btnClearDeposits">üßπ Clear all deposits</button>
      </div>
      <div class="note" style="margin-top:6px">Shares are calculated using each row's <b>Price</b> field below. If price is blank, we'll still track the dollars.</div>
    </section>

    <!-- NEW: Transaction History -->
    <section class="card" style="margin-top:16px">
        <h2 class="title">üìú Deposit History</h2>
        <div class="table-container" style="max-height: 200px; overflow-y: auto;">
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <!-- History rows will appear here -->
                </tbody>
            </table>
        </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h2 class="title">3) Portfolio Allocation</h2>
      <div class="note">Edit tickers, names, % allocations, and an optional current price to estimate shares on deposits. Totals should equal 100%.</div>
      <div class="hr"></div>
      <div class="row" style="justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap">
        <div class="badge">Total allocation: <b id="totalPct">100%</b></div>
        <div class="row" style="gap:8px">
          <div class="small muted">Quick Split ‚Äî enter a single amount to break down by your % allocation</div>
          <input class="input" id="lump" type="number" min="0" step="0.01" value="200" style="width:160px" />
          <button class="btn" id="btnLumpCSV">‚¨áÔ∏è Export Lump Split</button>
          <button class="btn" id="btnFetchPrices">‚ö° Fetch Live Prices</button>
          <button class="btn" id="btnAdd">Ôºã Add Row</button>
        </div>
      </div>
      <div class="hr" style="margin-top:12px; margin-bottom:12px;"></div>
      <div class="row" style="justify-content:flex-end;align-items:flex-end;gap:12px;flex-wrap:wrap">
        <div class="note" style="margin-right:auto;">For live prices, get a free <a href="https://www.alphavantage.co/support/#api-key" target="_blank" style="color: var(--text-secondary); text-decoration: underline;">AlphaVantage API Key</a>. The default 'demo' key is unreliable.</div>
        <div style="width: 220px;">
            <input class="input" id="apiKey" type="password" placeholder="Enter API Key" value="KSWYMZVUOXTZH0BT">
        </div>
      </div>

      <div class="table-container">
        <table id="allocTable" style="margin-top:10px">
            <thead>
              <tr>
                <th>Ticker</th>
                <th>Name</th>
                <th class="right">% Alloc</th>
                <th class="right">Est. Yield %</th>
                <th class="right nowrap">Price $</th>
                <th class="right nowrap">Lump $</th>
                <th class="right nowrap">Weekly $</th>
                <th class="right nowrap">Monthly $</th>
                <th class="right nowrap">Cum Invest $</th>
                <th class="right nowrap">Cum Shares</th>
                <th class="right nowrap">Avg Cost $</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="note">Yields are for planning only. Set DRIP in your broker.</div>
    </section>

    <section class="grid grid-2" style="margin-top:16px">
      <div class="card">
        <h2 class="title">4) Projection (Value Over Time)</h2>
        <div class="chart-container">
            <canvas id="valueChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h2 class="title">5) Projection (Dividends Per Year)</h2>
        <div class="chart-container">
            <canvas id="divChart"></canvas>
        </div>
      </div>
    </section>

    <footer class="row" style="justify-content:space-between;margin:22px 0 40px; padding: 0 10px;">
        <div class="row">
          <div class="muted small">Local storage only ‚Äî your data stays in your browser.</div>
          <div id="syncStatus" style="margin-left:12px;"></div>
        </div>
      <div class="row"><span class="badge">Built for daily DeFi ‚Üí dividend equity</span></div>
    </footer>

    <script type="module">
        // --- FIREBASE CONFIGURATION ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Use environment variable config if available (for Preview), else fallback to provided config
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
             firebaseConfig = JSON.parse(__firebase_config);
        } else {
             firebaseConfig = {
              apiKey: "AIzaSyB3NsS90rPdXFu3HpQ1M1LEncnCrXUonUA",
              authDomain: "defi-stock-planner.firebaseapp.com",
              projectId: "defi-stock-planner",
              storageBucket: "defi-stock-planner.firebasestorage.app",
              messagingSenderId: "456488490834",
              appId: "1:456488490834:web:3d7bf7eaa30b655fd8cc8b",
              measurementId: "G-9PK6XTFTSP"
            };
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Environment variable for App ID
        
        // --- APP LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
             // --- DOM ELEMENT SELECTORS ---
            const ids = [
                'sumDaily', 'sumDefiYear', 'sumToStocksYear', 'sumDivYear', 'sumCombinedYear', 'sumBlendedYield', 
                'broBalance', 'broInterestRate', 'broInterestInclude', 'broInclude',
                'etfTicker', 'etfName', 'etfStartNav', 'etfShares', 'etfNav', 'etfAUM', 'etfChange', 'btnEtfHelp', 'etfHelp',
                'simShares', 'btnSimBuy', 'btnSimSell', 'btnSetNavTo10',
                'xgUse', 'xgAmount', 'xgPrice', 'xgMethod', 'xgAPY', 'xgUsdValue', 'xgPerEpoch', 'xgEpochDays', 'xgFee', 'xgDaily',
                'xgAPYWrap', 'xgUSDWrap', 'xgEpochWrap', 'grailCoingeckoId', 'btnFetchGrailPrice',
                'dolomiteBalance', 'dolomiteApy', 'mortgageRate', 'mortgagePrincipal', 'dolomiteInclude', 'dolomiteYield', 'dolomiteMonthlyYield', 'dolomiteEquity',
                'daily', 'cadence', 'fees', 'pctStocks', 'pctDefi', 'years', 'growth', 'yield', 'drip', 'weeklyCash',
                'perHarvest', 'perWeek', 'perMonth', 'btnCalc', 'btnCSV',
                'btnSafetyHelp', 'safetyHelp',
                'btnRebalanceHelp', 'rebalanceHelp',
                'btnTaxHelp', 'taxHelp',
                'depAmount', 'depQuick', 'depDate', 'btnLogDeposit', 'btnClearDeposits',
                'totalPct', 'lump', 'btnLumpCSV', 'btnApplyLumpSplit', 'btnAdd', 'tbody', 'btnFetchPrices', 'apiKey', 'syncStatus',
                'historyBody'
            ];
            const dom = {};
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) dom[id] = el;
            });

            let valueChart, divChart;
            const DEFAULT_DOC_ID = 'planner_data';
            let currentUser = null;
            let depositHistory = [];

             // --- DATA & STATE MANAGEMENT ---
            const defaultAllocations = [
                { ticker: 'DTE', name: 'DTE Energy Co.', pct: 16.0, yield: 3.4, price: 141.13, invested: 141.13, shares: 1.00 },
                { ticker: 'SCHD', name: 'Schwab US Dividend ETF', pct: 16.0, yield: 3.5, price: 26.62, invested: 140.01, shares: 5.26 },
                { ticker: 'AWK', name: 'American Water Works', pct: 16.0, yield: 2.2, price: 140.77, invested: 142.18, shares: 1.01 },
                { ticker: 'ENB', name: 'Enbridge Inc.', pct: 16.0, yield: 7.6, price: 47.70, invested: 139.76, shares: 2.93 },
                { ticker: 'NEE', name: 'NextEra Energy', pct: 16.0, yield: 3.0, price: 84.26, invested: 140.71, shares: 1.67 },
                { ticker: 'EXC', name: 'Exelon Corp.', pct: 16.0, yield: 3.8, price: 46.64, invested: 139.44, shares: 2.99 },
                { ticker: 'SGOV', name: 'iShares 0-3 Month Treasury ETF', pct: 4.0, yield: 5.3, price: 100.00, invested: 0, shares: 0 },
            ];
            
             // --- AUTH & FIREBASE LOGIC ---
            async function initAuthAndSync() {
                dom.syncStatus.textContent = 'Connecting...';
                
                try {
                     // Check for custom token first (Standard immersive pattern)
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Auth error:", error);
                    dom.syncStatus.textContent = 'Auth Error (Offline Mode)';
                    renderAllocations(defaultAllocations); // Fallback
                    return;
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        dom.syncStatus.textContent = 'Connected';
                        setupRealtimeListener(user.uid);
                    } else {
                        dom.syncStatus.textContent = 'Disconnected';
                    }
                });
            }

            function setupRealtimeListener(userId) {
                // Use 'data' collection to ensure even number of segments
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', DEFAULT_DOC_ID);
                
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        loadStateFromData(data);
                        calculate(); // Recalc on load
                        dom.syncStatus.textContent = 'Synced';
                        dom.syncStatus.className = 'saved';
                    } else {
                        // No data yet, save defaults
                        renderAllocations(defaultAllocations);
                        saveToFirestore(); 
                    }
                }, (error) => {
                    console.error("Sync error:", error);
                    dom.syncStatus.textContent = 'Sync Error';
                    dom.syncStatus.className = 'error';
                });
            }

            const saveToFirestore = debounce(async () => {
                if (!currentUser) return;
                
                dom.syncStatus.textContent = 'Saving...';
                dom.syncStatus.className = 'saving';

                const allocations = [];
                dom.tbody.querySelectorAll('tr').forEach(row => {
                    allocations.push({
                        ticker: row.querySelector('.ticker').value,
                        name: row.querySelector('.name').value,
                        pct: parseFloat(row.querySelector('.pct').value) || 0,
                        yield: parseFloat(row.querySelector('.yield').value) || 0,
                        price: parseFloat(row.querySelector('.price').value) || 0,
                        invested: parseFloat(row.querySelector('.cum-invested').value) || 0,
                        shares: parseFloat(row.querySelector('.cum-shares').value) || 0,
                    });
                });

                const state = {
                    inputs: {},
                    allocations: allocations,
                    history: depositHistory, // Save history
                    timestamp: new Date().toISOString()
                };

                 // Save all input fields
                Object.keys(dom).forEach(key => {
                    const el = dom[key];
                    // Skip buttons, containers, non-input elements
                    if (el && (el.tagName === 'INPUT' || el.tagName === 'SELECT')) {
                        if (el.type === 'checkbox') {
                            state.inputs[key] = el.checked;
                        } else {
                            state.inputs[key] = el.value;
                        }
                    }
                });

                try {
                     const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', DEFAULT_DOC_ID);
                     await setDoc(docRef, state);
                     dom.syncStatus.textContent = 'Saved to Cloud';
                     dom.syncStatus.className = 'saved';
                } catch (e) {
                    console.error("Save error:", e);
                    dom.syncStatus.textContent = 'Save Failed';
                    dom.syncStatus.className = 'error';
                }
            }, 2000); // Debounce save every 2 seconds

            function loadStateFromData(data) {
                if (!data) return;

                // Load inputs
                if (data.inputs) {
                    Object.keys(data.inputs).forEach(key => {
                        if (dom[key]) {
                            if (dom[key].type === 'checkbox') {
                                dom[key].checked = data.inputs[key];
                            } else {
                                dom[key].value = data.inputs[key];
                            }
                        }
                    });
                }
                
                // Load allocations
                renderAllocations(data.allocations || defaultAllocations);

                // Load history
                depositHistory = data.history || [];
                renderHistory();
            }

            
            // --- HELPER FUNCTIONS ---
            function formatCurrency(val) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val); }
            function formatNumber(val, digits = 2) { return new Intl.NumberFormat('en-US', { minimumFractionDigits: digits, maximumFractionDigits: digits }).format(val); }
            function getNum(el) { return parseFloat(el?.value) || 0; }
            
            // Debounce implementation
            function debounce(func, delay) {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        func.apply(this, args);
                    }, delay);
                };
            }
            
            // Safely add event listener
            function addListener(id, event, handler) {
                const el = dom[id];
                if (el) {
                    el.addEventListener(event, handler);
                } 
            }


            // --- ALLOCATION TABLE LOGIC ---
            function renderAllocations(allocations) {
                dom.tbody.innerHTML = '';
                allocations.forEach(alloc => addRow(alloc));
                updateTotalPct();
            }
            
            function addRow(data = {}) {
                const tr = document.createElement('tr');
                const { ticker = '', name = '', pct = 0, yield: rowYield = 0, price = 0, invested = 0, shares = 0 } = data;
                
                tr.innerHTML = `
                    <td><input type="text" class="input ticker" value="${ticker.toUpperCase()}"></td>
                    <td><input type="text" class="input name" value="${name}"></td>
                    <td><input type="number" class="input right pct" value="${pct}" step="0.1" min="0" max="100"></td>
                    <td><input type="number" class="input right yield" value="${rowYield}" step="0.1" min="0"></td>
                    <td><input type="number" class="input right price" value="${price}" step="0.01" min="0"></td>
                    <td class="right mono lump-split">$0.00</td>
                    <td class="right mono weekly-split">$0.00</td>
                    <td class="right mono monthly-split">$0.00</td>
                    <td><input type="number" class="input right cum-invested" value="${invested.toFixed(2)}" step="0.01" min="0"></td>
                    <td><input type="number" class="input right cum-shares" value="${shares.toFixed(4)}" step="0.0001" min="0"></td>
                    <td class="right mono avg-cost">$0.00</td>
                    <td><button class="btn-delete">√ó</button></td>
                `;
                dom.tbody.appendChild(tr);

                const debouncedCalculate = debounce(() => {
                    calculate();
                    saveToFirestore();
                }, 500);

                tr.querySelector('.btn-delete').addEventListener('click', () => {
                    tr.remove();
                    debouncedCalculate();
                });
                tr.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', () => {
                        if (input.classList.contains('cum-invested') || input.classList.contains('cum-shares')) {
                           updateAvgCost(tr);
                        }
                        debouncedCalculate();
                    });
                });
                updateAvgCost(tr);
            }

            function updateTotalPct() {
                let total = 0;
                dom.tbody.querySelectorAll('.pct').forEach(input => total += getNum(input));
                dom.totalPct.textContent = `${formatNumber(total, 1)}%`;
                dom.totalPct.classList.toggle('warning', total.toFixed(1) != 100.0);
                dom.totalPct.classList.toggle('up', total.toFixed(1) == 100.0);
            }

            function updateAvgCost(row) {
                const invested = parseFloat(row.querySelector('.cum-invested').value) || 0;
                const shares = parseFloat(row.querySelector('.cum-shares').value) || 0;
                row.querySelector('.avg-cost').textContent = formatCurrency(shares > 0 ? invested / shares : 0);
            }

            // --- HISTORY LOGIC ---
            function renderHistory() {
                dom.historyBody.innerHTML = '';
                // Sort by date desc
                const sorted = [...depositHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sorted.forEach((entry, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${entry.date}</td>
                        <td>${formatCurrency(entry.amount)}</td>
                        <td>${entry.type}</td>
                        <td><button class="btn-delete" data-index="${index}" title="Delete Log">√ó</button></td>
                    `;
                    // Add delete listener
                    tr.querySelector('.btn-delete').addEventListener('click', () => {
                         if(confirm("Delete this history entry? (Note: This only removes the log, it does NOT subtract from your totals)")) {
                             depositHistory.splice(index, 1); // Remove from array
                             renderHistory(); // Re-render
                             saveToFirestore(); // Save
                         }
                    });
                    dom.historyBody.appendChild(tr);
                });
            }

            // --- DEPOSIT LOGIC ---
            function logDeposit() {
                const amount = getNum(dom.depAmount);
                if (amount <= 0) return;

                // 1. Update Totals
                dom.tbody.querySelectorAll('tr').forEach(row => {
                    const pct = (parseFloat(row.querySelector('.pct').value) || 0) / 100;
                    const price = parseFloat(row.querySelector('.price').value) || 0;
                    
                    const depositForTicker = amount * pct;
                    const sharesBought = price > 0 ? depositForTicker / price : 0;
                    
                    const investedInput = row.querySelector('.cum-invested');
                    const sharesInput = row.querySelector('.cum-shares');

                    const currentInvested = parseFloat(investedInput.value) || 0;
                    const currentShares = parseFloat(sharesInput.value) || 0;

                    investedInput.value = (currentInvested + depositForTicker).toFixed(2);
                    sharesInput.value = (currentShares + sharesBought).toFixed(4);
                    
                    updateAvgCost(row);
                });
                
                // 2. Log to History
                const typeMap = {
                    '': 'Manual',
                    'week': 'Weekly',
                    'month': 'Monthly',
                    'harvest': 'DeFi Harvest'
                };
                
                const newEntry = {
                    date: dom.depDate.value || new Date().toISOString().split('T')[0],
                    amount: amount,
                    type: typeMap[dom.depQuick.value] || 'Manual'
                };
                
                depositHistory.push(newEntry);
                renderHistory();

                dom.depAmount.value = '';
                calculate();
                saveToFirestore();
            }
            
            function clearDeposits() {
                if (window.confirm('Are you sure you want to clear all cumulative deposit data? This cannot be undone.')) {
                     dom.tbody.querySelectorAll('tr').forEach(row => {
                        row.querySelector('.cum-invested').value = '0.00';
                        row.querySelector('.cum-shares').value = '0.0000';
                        updateAvgCost(row);
                    });
                    calculate();
                    saveToFirestore();
                }
            }
            
            function handleQuickDeposit() {
                const val = dom.depQuick.value;
                if (val === 'week') dom.depAmount.value = dom.perWeek.dataset.raw || 0;
                else if (val === 'month') dom.depAmount.value = dom.perMonth.dataset.raw || 0;
                else if (val === 'harvest') dom.depAmount.value = dom.perHarvest.dataset.raw || 0;
            }
            
            // --- QUICK SPLIT ---
            function applyLumpSplit() {
                const lump = getNum(dom.lump);
                dom.tbody.querySelectorAll('tr').forEach(row => {
                    const pct = (parseFloat(row.querySelector('.pct').value) || 0) / 100;
                    row.querySelector('.lump-split').textContent = formatCurrency(lump * pct);
                });
            }

            // --- CSV EXPORT ---
            function exportCSV(isLump) {
                let csv = 'Ticker,Name,% Allocation,' + (isLump ? 'Lump Amount ($)\n' : 'Weekly Amount ($),Monthly Amount ($)\n');
                dom.tbody.querySelectorAll('tr').forEach(row => {
                    const ticker = row.querySelector('.ticker').value;
                    const name = row.querySelector('.name').value;
                    const pct = row.querySelector('.pct').value;
                    if (isLump) {
                        const lump = row.querySelector('.lump-split').textContent;
                        csv += `${ticker},"${name}",${pct},${lump.replace('$', '')}\n`;
                    } else {
                        const weekly = row.querySelector('.weekly-split').textContent;
                        const monthly = row.querySelector('.monthly-split').textContent;
                        csv += `${ticker},"${name}",${pct},${weekly.replace('$', '')},${monthly.replace('$', '')}\n`;
                    }
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `${isLump ? 'lump_sum_split' : 'allocation'}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // --- PRICE APIS ---
            async function fetchGrailPrice() {
                const coingeckoId = dom.grailCoingeckoId.value.trim().toLowerCase();
                if (!coingeckoId) return;
                
                dom.btnFetchGrailPrice.disabled = true;
                dom.btnFetchGrailPrice.innerHTML = '...';

                try {
                    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${coingeckoId}&vs_currencies=usd`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();

                    if (data[coingeckoId] && data[coingeckoId].usd) {
                        dom.xgPrice.value = data[coingeckoId].usd.toFixed(2);
                        calculate();
                        saveToFirestore();
                    } else {
                         console.warn(`No price data for ID "${coingeckoId}"`, data);
                    }
                } catch (error) {
                    console.error('Error fetching CoinGecko price:', error);
                } finally {
                    dom.btnFetchGrailPrice.disabled = false;
                    dom.btnFetchGrailPrice.innerHTML = '‚ö°';
                }
            }

            // --- NEW SMART FETCH FUNCTION ---
            async function fetchStockPrices() {
                dom.btnFetchPrices.disabled = true;
                const originalText = dom.btnFetchPrices.textContent;
                dom.btnFetchPrices.textContent = 'Fetching...';

                const apiKey = dom.apiKey.value.trim() || 'demo';
                const rows = Array.from(dom.tbody.querySelectorAll('tr'));
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const ticker = row.querySelector('.ticker').value.trim().toUpperCase();
                    if (!ticker) continue;

                    // Visual feedback: Processing
                    row.style.transition = 'background-color 0.3s';
                    row.style.backgroundColor = 'rgba(0, 123, 255, 0.2)'; // Blueish tint

                    try {
                        const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${ticker}&apikey=${apiKey}`;
                        const response = await fetch(url);
                        const data = await response.json();

                        // --- RATE LIMIT CHECK ---
                        if (data['Note'] && data['Note'].includes("call frequency")) {
                            console.warn(`Rate limit hit at ${ticker}. Pausing...`);
                            row.style.backgroundColor = 'rgba(255, 193, 7, 0.3)'; // Yellow warning
                            
                            // Countdown timer
                            for (let s = 65; s > 0; s--) {
                                dom.btnFetchPrices.textContent = `Limit Hit. Wait ${s}s...`;
                                await new Promise(r => setTimeout(r, 1000));
                            }
                            
                            // Reset button text and retry THIS index
                            dom.btnFetchPrices.textContent = 'Resuming...';
                            i--; // Go back one step to retry current stock
                            continue; 
                        }

                        const price = data?.['Global Quote']?.['05. price'];

                        if (price) {
                            row.querySelector('.price').value = parseFloat(price).toFixed(2);
                            row.style.backgroundColor = 'rgba(40, 167, 69, 0.3)'; // Green success
                        } else {
                             console.warn(`No data for ${ticker}`, data);
                             row.style.backgroundColor = 'rgba(220, 53, 69, 0.3)'; // Red error
                        }
                    } catch (error) {
                        console.error(`Error fetching ${ticker}:`, error);
                        row.style.backgroundColor = 'rgba(220, 53, 69, 0.3)';
                    }

                    // Remove highlight after a bit
                    setTimeout(() => { row.style.backgroundColor = ''; }, 2000);

                    // Polite delay between calls
                    await new Promise(r => setTimeout(r, 1500)); 
                }

                dom.btnFetchPrices.disabled = false;
                dom.btnFetchPrices.textContent = originalText;
                calculate();
                saveToFirestore();
            }


            // --- CORE CALCULATION ENGINE ---
            function calculate() {
                // Read all inputs
                const xgUse = dom.xgUse.checked;
                const xgAmount = getNum(dom.xgAmount);
                const xgPrice = getNum(dom.xgPrice);
                const xgMethod = dom.xgMethod.value;
                const xgAPY = getNum(dom.xgAPY);
                const xgPerEpoch = getNum(dom.xgPerEpoch);
                const xgEpochDays = getNum(dom.xgEpochDays);
                const xgFee = getNum(dom.xgFee);
                let xgUsdValue = getNum(dom.xgUsdValue);
                if (xgPrice > 0) {
                  xgUsdValue = xgAmount * xgPrice;
                  dom.xgUsdValue.value = xgUsdValue.toFixed(2);
                }

                let dailyDeFi = getNum(dom.daily);
                let xgDaily = 0;
                if(xgUse) {
                    if(xgMethod === 'apy') {
                        xgDaily = (xgUsdValue * (xgAPY / 100)) / 365;
                    } else { // epoch
                        if (xgEpochDays > 0) {
                            xgDaily = (xgAmount * xgPerEpoch) / xgEpochDays;
                        } else {
                            xgDaily = 0;
                        }
                    }
                    xgDaily *= (1 - xgFee / 100);
                    dom.xgDaily.textContent = formatCurrency(xgDaily);
                    dom.daily.value = xgDaily.toFixed(2);
                    dailyDeFi = xgDaily;
                }
                
                // Mortgage Offset Calculation
                const dolomiteBalance = getNum(dom.dolomiteBalance);
                const dolomiteApy = getNum(dom.dolomiteApy) / 100;
                const mortgageRate = getNum(dom.mortgageRate) / 100;
                const annualDolomiteYield = dolomiteBalance * dolomiteApy;
                dom.dolomiteYield.textContent = formatCurrency(annualDolomiteYield);
                dom.dolomiteMonthlyYield.textContent = formatCurrency(annualDolomiteYield / 12);
                const effectiveEquity = mortgageRate > 0 ? annualDolomiteYield / mortgageRate : 0;
                dom.dolomiteEquity.textContent = formatCurrency(effectiveEquity);
                
                if (dom.dolomiteInclude.checked) {
                    dailyDeFi += annualDolomiteYield / 365.25;
                    dom.daily.value = dailyDeFi.toFixed(2);
                }
                
                // Brokerage Interest Calculation
                const broBalance = getNum(dom.broBalance);
                const broInterestRate = getNum(dom.broInterestRate) / 100;
                if (dom.broInterestInclude.checked && broBalance > 0 && broInterestRate > 0) {
                    const dailyBrokerageInterest = (broBalance * broInterestRate) / 365.25;
                    dailyDeFi += dailyBrokerageInterest;
                    dom.daily.value = dailyDeFi.toFixed(2);
                }


                const weeklyCash = getNum(dom.weeklyCash);
                const cadence = dom.cadence.value;
                const fees = getNum(dom.fees);
                const pctStocks = getNum(dom.pctStocks) / 100;
                const pctDefiNum = getNum(dom.pctDefi) / 100;
                const years = getNum(dom.years);
                const growth = getNum(dom.growth) / 100;
                const avgDivYield = getNum(dom.yield) / 100;
                const drip = dom.drip.value === 'yes';

                // Calculate investment amounts
                const daysPerHarvest = { daily: 1, weekly: 7, biweekly: 14, monthly: 30.44 }[cadence];
                const grossPerHarvest = dailyDeFi * daysPerHarvest;
                const netPerHarvest = Math.max(0, grossPerHarvest - fees);
                const toStocksPerHarvest = netPerHarvest * pctStocks;
                
                const weeklyDeFiInvest = (toStocksPerHarvest / daysPerHarvest) * 7;
                const weeklyInvest = weeklyDeFiInvest + weeklyCash;
                const monthlyInvest = weeklyInvest * (30.44 / 7);
                const yearlyInvest = weeklyInvest * (365.25 / 7);

                dom.perHarvest.textContent = formatCurrency(toStocksPerHarvest);
                dom.perHarvest.dataset.raw = toStocksPerHarvest.toFixed(2);
                dom.perWeek.textContent = formatCurrency(weeklyInvest);
                dom.perWeek.dataset.raw = weeklyInvest.toFixed(2);
                dom.perMonth.textContent = formatCurrency(monthlyInvest);
                dom.perMonth.dataset.raw = monthlyInvest.toFixed(2);

                // Update Allocation Table Splits
                dom.tbody.querySelectorAll('tr').forEach(row => {
                    const pct = (parseFloat(row.querySelector('.pct').value) || 0) / 100;
                    row.querySelector('.weekly-split').textContent = formatCurrency(weeklyInvest * pct);
                    row.querySelector('.monthly-split').textContent = formatCurrency(monthlyInvest * pct);
                });
                applyLumpSplit(); // Ensure lump split is up to date
                updateTotalPct();

                // Calculate current market value of stocks
                let stockMarketValue = 0;
                dom.tbody.querySelectorAll('tr').forEach(row => {
                    const shares = parseFloat(row.querySelector('.cum-shares').value) || 0;
                    const price = parseFloat(row.querySelector('.price').value) || 0;
                    stockMarketValue += shares * price;
                });

                // Update Summary Card
                const uninvestedCash = getNum(dom.broBalance);
                const brokerageMarketValue = uninvestedCash + stockMarketValue;

                const onChainYearly = dailyDeFi * 365.25 * pctDefiNum;
                const divYear1 = (brokerageMarketValue + yearlyInvest) * avgDivYield;

                dom.sumDaily.textContent = formatCurrency(dailyDeFi);
                dom.sumDefiYear.textContent = formatCurrency(onChainYearly);
                dom.sumToStocksYear.textContent = formatCurrency(yearlyInvest);
                dom.sumDivYear.textContent = formatCurrency(divYear1);
                dom.sumCombinedYear.textContent = formatCurrency(onChainYearly + divYear1);

                // Blended Yield
                const includeBrokerage = dom.broInclude.checked;
                const principal = (includeBrokerage ? brokerageMarketValue : 0) + (xgUsdValue || 0) + dolomiteBalance;
                if (principal > 0) {
                    const blendedYield = (onChainYearly + divYear1) / principal * 100;
                    dom.sumBlendedYield.textContent = `${formatNumber(blendedYield, 2)}%`;
                } else {
                    dom.sumBlendedYield.textContent = '‚Äì';
                }

                // Update ETF Wizard
                const etfShares = getNum(dom.etfShares);
                const startNav = getNum(dom.etfStartNav);
                const aum = xgUsdValue + brokerageMarketValue + dolomiteBalance;
                const liveNav = etfShares > 0 ? aum / etfShares : 0;
                const change = startNav > 0 ? (liveNav - startNav) / startNav * 100 : 0;
                
                dom.etfAUM.textContent = formatCurrency(aum);
                dom.etfNav.textContent = formatCurrency(liveNav);
                dom.etfChange.textContent = `${formatNumber(change, 2)}%`;
                dom.etfChange.className = 'mono ' + (change >= 0 ? 'up' : 'down');

                // Update charts
                updateProjectionCharts(brokerageMarketValue, yearlyInvest, growth, avgDivYield, years, drip);
                
                // Save state after calculation
                saveState();
            }

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                const debouncedCalculate = debounce(() => {
                    calculate();
                    saveToFirestore(); // Auto-save on calc
                }, 300);
                
                // Calculation Triggers on input fields
                const inputs = document.querySelectorAll('.input, select');
                inputs.forEach(input => input.addEventListener('input', debouncedCalculate));
                
                // xGRAIL UI Toggle
                addListener('xgMethod', 'change', () => {
                    const isApy = dom.xgMethod.value === 'apy';
                    dom.xgAPYWrap.style.display = isApy ? 'block' : 'none';
                    dom.xgUSDWrap.style.display = isApy ? 'block' : 'none';
                    dom.xgEpochWrap.style.display = isApy ? 'none' : 'flex';
                });
                // Safe dispatch
                const xgMethodEl = dom.xgMethod;
                if (xgMethodEl) {
                   xgMethodEl.dispatchEvent(new Event('change'));
                }

                // Auto-sync percentages
                addListener('pctStocks', 'input', () => {
                    dom.pctDefi.value = 100 - getNum(dom.pctStocks);
                    debouncedCalculate();
                });
                addListener('pctDefi', 'input', () => {
                    dom.pctStocks.value = 100 - getNum(dom.pctDefi);
                    debouncedCalculate();
                });
                
                // Button Clicks (immediate calculation)
                addListener('btnCalc', 'click', () => { calculate(); saveToFirestore(); });
                addListener('btnAdd', 'click', () => addRow());
                addListener('btnCSV', 'click', () => exportCSV(false));
                addListener('btnLumpCSV', 'click', () => exportCSV(true));
                addListener('btnApplyLumpSplit', 'click', applyLumpSplit);
                addListener('btnLogDeposit', 'click', logDeposit);
                addListener('btnClearDeposits', 'click', clearDeposits);
                addListener('depQuick', 'change', handleQuickDeposit);
                addListener('btnFetchPrices', 'click', fetchStockPrices);
                addListener('btnFetchGrailPrice', 'click', fetchGrailPrice);
                
                // Simulator buttons
                addListener('btnSimBuy', 'click', () => {
                    const currentShares = getNum(dom.etfShares);
                    const simShares = getNum(dom.simShares);
                    dom.etfShares.value = Math.max(0, currentShares - simShares);
                    calculate();
                    saveToFirestore();
                });

                addListener('btnSimSell', 'click', () => {
                    const currentShares = getNum(dom.etfShares);
                    const simShares = getNum(dom.simShares);
                    dom.etfShares.value = currentShares + simShares;
                    calculate();
                    saveToFirestore();
                });
                
                addListener('btnSetNavTo10', 'click', () => {
                    const aumText = dom.etfAUM.textContent;
                    const aum = parseFloat(aumText.replace(/[^0-9.-]+/g,""));
                    if (aum > 0) {
                        dom.etfShares.value = Math.round(aum / 10);
                        calculate();
                        saveToFirestore();
                    }
                });


                // Accordion Toggles
                addListener('btnEtfHelp', 'click', () => {
                   const help = dom.etfHelp;
                   help.style.display = help.style.display === 'block' ? 'none' : 'block';
                });
                addListener('btnSafetyHelp', 'click', (e) => {
                   const help = dom.safetyHelp;
                   const isHidden = help.style.display === 'none' || help.style.display === '';
                   help.style.display = isHidden ? 'block' : 'none';
                   e.target.textContent = isHidden ? 'Hide Details' : 'Show Details';
                });
                 addListener('btnRebalanceHelp', 'click', (e) => {
                   const help = dom.rebalanceHelp;
                   const isHidden = help.style.display === 'none' || help.style.display === '';
                   help.style.display = isHidden ? 'block' : 'none';
                   e.target.textContent = isHidden ? 'Hide Details' : 'Show Details';
                });
                addListener('btnTaxHelp', 'click', (e) => {
                   const help = dom.taxHelp;
                   const isHidden = help.style.display === 'none' || help.style.display === '';
                   help.style.display = isHidden ? 'block' : 'none';
                   e.target.textContent = isHidden ? 'Hide Details' : 'Show Details';
                });
            }

            // --- INITIALIZATION ---
            function init() {
                initAuthAndSync(); // Kick off Auth & Sync
                setupEventListeners();
            }

            init();
        });
    </script>
</body>
</html>
